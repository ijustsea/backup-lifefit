name: LifeFit Back-end CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v3

      # 2. JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Gradle ë¹Œë“œ
      - name: Build with Gradle
        working-directory: ./lifeFit
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # 4. JAR íŒŒì¼ì„ EC2 ì„ì‹œ í´ë”ë¡œ ì „ì†¡
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          # ë¹Œë“œëœ ìœ„ì¹˜ì˜ jarë¥¼ temp í´ë”ë¡œ ì „ì†¡
          source: "lifeFit/build/libs/*.jar"
          target: "/home/ubuntu/lifefit/LifeFit-back/lifeFit/temp"

      # 5. Blue-Green ë¬´ì¤‘ë‹¨ ë°°í¬ ë¡œì§ (ìˆ˜ì •ëœ ë¶€ë¶„)
      - name: Blue-Green Safe Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            APP_DIR="/home/ubuntu/lifefit/LifeFit-back/lifeFit"
            TEMP_DIR="$APP_DIR/temp"
            NGINX_CONF="/etc/nginx/sites-available/lifefit"

            mkdir -p $TEMP_DIR
            cd $APP_DIR

            echo "â–¶ Detect current port from Nginx"
            # Nginx ì„¤ì •íŒŒì¼ì—ì„œ í˜„ì¬ ì„¤ì •ëœ í¬íŠ¸ ë²ˆí˜¸ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
            CURRENT_PORT=$(grep -oP 'set \$backend_port \K[0-9]+' $NGINX_CONF)
            
            if [ -z "$CURRENT_PORT" ]; then
              echo "âŒ Cannot detect current backend port from nginx"
              exit 1
            fi
            
            if [ "$CURRENT_PORT" = "8080" ]; then
              TARGET_PORT=8081
              TARGET_COLOR="green"
            else
              TARGET_PORT=8080
              TARGET_COLOR="blue"
            fi

            echo "â–¶ Current=$CURRENT_PORT â†’ Target=$TARGET_PORT ($TARGET_COLOR)"

            # ì‹ ê·œ JAR íŒŒì¼ ì°¾ê¸° (temp í´ë” ë‚´ ì „ì†¡ëœ íŒŒì¼)
            # scp-actionìœ¼ë¡œ ì „ì†¡í•˜ë©´ ì›ë³¸ ê²½ë¡œ êµ¬ì¡°ê°€ í¬í•¨ë˜ë¯€ë¡œ findë¥¼ ì‚¬ìš©í•´ ì‹¤ì œ jar íŒŒì¼ ìœ„ì¹˜ë¥¼ ì¡ìŠµë‹ˆë‹¤.
            NEW_JAR=$(find "$TEMP_DIR" -type f -name "*.jar" ! -name "*plain.jar" -print0 | xargs -0 ls -t | head -n 1)
            [ -z "$NEW_JAR" ] && echo "âŒ No JAR found in temp directory" && exit 1

            TARGET_JAR="lifefit-$TARGET_COLOR.jar"

            echo "â–¶ Backup existing $TARGET_JAR"
            [ -f "$TARGET_JAR" ] && mv "$TARGET_JAR" "$TARGET_JAR.bak"

            echo "â–¶ Apply new JAR to $TARGET_JAR"
            mv "$NEW_JAR" "$TARGET_JAR"
            # ì „ì†¡ëœ ì°Œêº¼ê¸° í´ë”/íŒŒì¼ ì •ë¦¬
            rm -rf "$TEMP_DIR"/*

            echo "â–¶ Restart target service (lifefit-$TARGET_COLOR)"
            sudo systemctl restart lifefit-$TARGET_COLOR
            sleep 5

            # 1ì°¨ ì‹œë™ í™•ì¸
            sudo systemctl is-active --quiet lifefit-$TARGET_COLOR || {
              echo "âŒ systemd failed to start lifefit-$TARGET_COLOR"
              if [ -f "$TARGET_JAR.bak" ]; then
                mv "$TARGET_JAR.bak" "$TARGET_JAR"
                sudo systemctl restart lifefit-$TARGET_COLOR
              fi
              exit 1
            }

            echo "â–¶ Health check starting on http://127.0.0.1:$TARGET_PORT/health"
            HEALTH_SUCCESS=false
            for i in {1..20}; do
              STATUS=$(curl -s http://127.0.0.1:$TARGET_PORT/health || echo "fail")
              if [ "$STATUS" = "OK" ]; then
                echo "âœ… Health check success on port $TARGET_PORT"
                HEALTH_SUCCESS=true
                break
              fi
              echo "â³ Waiting for server... ($i/20)"
              sleep 5
            done

            if [ "$HEALTH_SUCCESS" = false ]; then
              echo "âŒ Health check failed â†’ Rolling back"
              if [ -f "$TARGET_JAR.bak" ]; then
                mv "$TARGET_JAR.bak" "$TARGET_JAR"
                sudo systemctl restart lifefit-$TARGET_COLOR
              fi
              exit 1
            fi

            echo "â–¶ Switch Nginx traffic to $TARGET_PORT"
            sudo sed -i "s/set \$backend_port .*/set \$backend_port $TARGET_PORT;/" $NGINX_CONF
            sudo systemctl reload nginx || {
              echo "âŒ Nginx reload failed â†’ rollback"
              sudo sed -i "s/set \$backend_port .*/set \$backend_port $CURRENT_PORT;/" $NGINX_CONF
              sudo systemctl reload nginx
              exit 1
            }
            
            echo "â–¶ Stop old service"
            if [ "$TARGET_COLOR" = "green" ]; then
              sudo systemctl stop lifefit-blue || echo "Already stopped"
            else
              sudo systemctl stop lifefit-green || echo "Already stopped"
            fi

            rm -f "$TARGET_JAR.bak"
            echo "ğŸš€ Blue-Green Deploy Complete! Service is now on $TARGET_PORT"