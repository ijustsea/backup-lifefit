name: LifeFit Back-end CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v3

      # 2. JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # ë¹Œë“œ ì „ application-prod.yml ìƒì„±
      - name: Create application-prod.yml
        run: |
          mkdir -p ./lifeFit/src/main/resources
          echo "spring:
            datasource:
              url: ${{ secrets.DB_URL }}
              username: ${{ secrets.DB_USERNAME }}
              password: ${{ secrets.DB_PASSWORD }}
              driver-class-name: com.mysql.cj.jdbc.Driver
            jpa:
              hibernate:
                ddl-auto: validate
            data:
              redis:
                host: ${{ secrets.UPSTASH_REDIS_HOST }}
                port: 6379
                password: ${{ secrets.UPSTASH_REDIS_PASSWORD }}
                ssl:
                  enabled: true
            kafka:
              bootstrap-servers: ${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}
              properties:
                security.protocol: SASL_SSL
                sasl.mechanism: PLAIN
                sasl.jaas.config: 'org.apache.kafka.common.security.plain.PlainLoginModule required username="${{ secrets.KAFKA_API_KEY }}" password="${{ secrets.KAFKA_API_SECRET }}";'          
          cloud:
            aws:
              region:
                static: ap-northeast-2
              credentials:
                access-key: ${{ secrets.S3_ACCESS_KEY }}
                secret-key: ${{ secrets.S3_SECRET_KEY }}
              stack:
                auto: false
          jwt:
            secret: ${{ secrets.JWT_SECRET }}
          server:
            port: 8080" > ./lifeFit/src/main/resources/application-prod.yml

      # 3. Gradle ë¹Œë“œ
      - name: Build with Gradle
        working-directory: ./lifeFit
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # 4. JAR ì´ë¦„ ê³ ì • ë° Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker Image
        run: |
          rm -f ./app.jar
          find ./lifeFit/build/libs/ -name "*.jar" ! -name "*plain.jar" -exec cp {} ./app.jar \;
          
          ls -l ./app.jar
          docker build -t lifefit-api:latest .
          docker save lifefit-api:latest > lifefit-api.tar

      # 5. ì•„í‹°íŒ©íŠ¸ ì „ì†¡ (ì´ë¯¸ì§€ + ì»´í¬ì¦ˆ ì„¤ì •)
      - name: Copy to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "lifefit-api.tar, docker-compose.yml"
          target: "/home/ubuntu/lifefit/deploy"

      # 6. ë¬´ì¤‘ë‹¨ ì „í™˜ ë¡œì§
      - name: Docker Blue-Green Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            NGINX_CONF="/etc/nginx/sites-available/lifefit"
            cd /home/ubuntu/lifefit/deploy

            echo "â–¶ ì´ë¯¸ì§€ ë¡œë“œ"
            docker load < lifefit-api.tar

            # Nginxì—ì„œ í˜„ì¬ í™œì„± í¬íŠ¸ ì¶”ì¶œ
            CURRENT_PORT=$(grep -oP 'set \$backend_port \K[0-9]+' $NGINX_CONF || echo "8081")
            
            if [ "$CURRENT_PORT" = "8080" ]; then
              TARGET_PORT=8081; TARGET_COLOR="green"; OLD_COLOR="blue"
            else
              TARGET_PORT=8080; TARGET_COLOR="blue"; OLD_COLOR="green"
            fi

            echo "â–¶ $TARGET_COLOR ($TARGET_PORT) ì‹ ê·œ ê°€ë™"
            docker compose up -d lifefit-$TARGET_COLOR

            # Health Check
            HEALTH_SUCCESS=false
            for i in {1..50}; do
              if [ "$(curl -s http://127.0.0.1:$TARGET_PORT/health)" = "OK" ]; then
                HEALTH_SUCCESS=true; break
              fi
              echo "â³ ëŒ€ê¸° ì¤‘... ($i/50)"; sleep 5
            done

            if [ "$HEALTH_SUCCESS" = false ]; then
              echo "âŒ ë°°í¬ ì‹¤íŒ¨"; exit 1
            fi

            echo "â–¶ Nginx ì „í™˜ ë° ì •ë¦¬"
            sudo sed -i "s/set \$backend_port .*/set \$backend_port $TARGET_PORT;/" $NGINX_CONF
            sudo systemctl reload nginx

            # ì•ˆì „í•œ ì •ë¦¬: ì´ì „ ì»¨í…Œì´ë„ˆë§Œ ì •ì§€í•˜ê³  ì´ë¯¸ì§€ëŠ” ìºì‹œ ìœ ì§€
            docker compose stop lifefit-$OLD_COLOR || true
            docker image prune -f  # <--- system ëŒ€ì‹  image pruneìœ¼ë¡œ ì•ˆì „í•˜ê²Œ!
            rm -f lifefit-api.tar
            
            echo "ğŸš€ ë°°í¬ ì™„ë²½ ì„±ê³µ!"
